<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta content="same-origin" name="referrer" />
    <title>Chaos Danmu Tool</title>

    <script>
      document.write("Loading");
    </script>

    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script
      crossorigin
      src="https://unpkg.com/react@17/umd/react.development.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"
    ></script>

    <script>
      document.body.innerText = "";
    </script>

    <style name="global">
      body {
        margin: 0;
        padding: 0;
        /*zoom: 10;*/
        zoom: 2;
        /*font-size: 1cm;*/
        /*font-family: "Monospaced", serif;*/
      }
    </style>
    <style name="userInfo">
      .user-info {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
      }

      .user-info > div {
        margin-right: 0.4em;
      }

      .fans-medal {
        display: flex;
      }

      .fans-medal > div {
        padding: 0 0.2em 0 0.2em;
        border-style: solid;
        display: flex;
        justify-content: space-around;
        align-items: center;
      }

      .medal-name {
        border-width: 0.05em 0 0.05em 0.05em;
        border-radius: 0.4em 0 0 0.4em;
        color: #fff;
      }

      .medal-level {
        min-width: 1.2em;
        border-width: 0.05em 0.05em 0.05em 0;
        border-radius: 0 0.4em 0.4em 0;
        background-color: #fff;
      }

      .text-icon {
        border-width: 0.05em;
        border-style: solid;
        border-radius: 0.3em;
        padding: 0 0.2em 0 0.2em;
      }
    </style>
    <style name="danmu">
      .danmu-item {
        display: flex;
        flex-wrap: wrap;
        margin-top: 0.3em;
        word-break: break-all;
      }
    </style>

    <script type="text/babel">
      let internal = false;
      let commandNum = 0;

      function randint(min, max) {
        return Math.floor(Math.random() * (max - min) + min);
      }

      function formatNumber(number) {
        if (number <= 999) {
          return number;
        } else if (number <= 9999) {
          return (number / 1000).toFixed(1) + "千";
        } else if (number <= 99999999) {
          return (number / 10000).toFixed(1) + "万";
        } else {
          return (number / 100000000).toFixed(1) + "亿";
        }
      }

      function rgbI2S(num) {
        if (typeof num === "number") {
          return "#" + num.toString(16).padStart(6, "0");
        } else {
          return "#000";
        }
      }

      function rgbaI2S(num) {
        if (typeof num === "number") {
          return "#" + num.toString(16).padStart(8, "0");
        } else {
          return "#000";
        }
      }

      class TextIcon extends React.Component {
        render() {
          return (
            <div
              className={"text-icon"}
              style={{
                color: this.props.color,
                backgroundColor: this.props.backgroundColor,
                borderColor: this.props.borderColor,
              }}
            >
              {this.props.text}
            </div>
          );
        }
      }

      class AdminIcon extends React.Component {
        render() {
          let iconStyle = this.props.config.style.adminIcon;
          return (
            <TextIcon
              className={"admin-icon"}
              text={iconStyle.text}
              color={iconStyle.textColor}
              backgroundColor={iconStyle.backgroundColor}
              borderColor={iconStyle.borderColor}
            />
          );
        }
      }

      class VipIcon extends React.Component {
        render() {
          let iconStyle = this.props.config.style.vipIcon;
          return (
            <TextIcon
              className={"vip-icon"}
              text={iconStyle.text}
              color={iconStyle.textColor}
              backgroundColor={iconStyle.backgroundColor}
              borderColor={iconStyle.borderColor}
            />
          );
        }
      }

      class SVipIcon extends React.Component {
        render() {
          let iconStyle = this.props.config.style.sVipIcon;
          return (
            <TextIcon
              className={"svip-icon"}
              text={iconStyle.text}
              color={iconStyle.textColor}
              backgroundColor={iconStyle.backgroundColor}
              borderColor={iconStyle.borderColor}
            />
          );
        }
      }

      class FansMedal extends React.Component {
        render() {
          const medalInfo = this.props.medalInfo;
          return this.props.medalInfo ? (
            <div className={"fans-medal"}>
              <div
                className={"medal-name"}
                style={{
                  borderColor: rgbI2S(medalInfo.medal_color_border),
                  backgroundImage: "linear-gradient(45deg,{0},{1})"
                    .replace("{0}", rgbI2S(medalInfo.medal_color_start))
                    .replace("{1}", rgbI2S(medalInfo.medal_color_end)),
                }}
              >
                {this.props.medalInfo.medal_name}
              </div>
              <div
                className={"medal-level"}
                style={{
                  borderColor: rgbI2S(medalInfo.medal_color_border),
                  color: rgbI2S(medalInfo.medal_color),
                }}
              >
                {this.props.medalInfo.medal_level}
              </div>
            </div>
          ) : null;
        }
      }

      class UserInfo extends React.Component {
        render() {
          return (
            <div className={"user-info"}>
              <FansMedal medalInfo={this.props.medalInfo} />
              {this.props.admin && <AdminIcon config={this.props.config} />}
              {this.props.vip && <VipIcon config={this.props.config} />}
              {this.props.svip && <SVipIcon config={this.props.config} />}
            </div>
          );
        }
      }

      const DanmuMessage = {
        Unsupported: function (props) {
          return (
            <div className={"danmu-item"}>不支持的消息: {props.value.cmd}</div>
          );
        },
        Danmu: function (props) {
          return (
            <div className={"danmu-item"}>
              <UserInfo
                config={props.config}
                medalInfo={props.value.medalInfo}
                admin={props.value.isAdmin}
                vip={props.value.isVip}
                svip={props.value.isSVip}
              />
              <div>{props.value.content}</div>
            </div>
          );
        },
      };

      class DanmuItem extends React.Component {
        render() {
          switch (this.props.value.cmd) {
            case "DANMU_MSG": {
              return (
                <DanmuMessage.Danmu
                  config={this.props.config}
                  value={this.props.value}
                />
              );
            }
            default: {
              return <DanmuMessage.Unsupported value={this.props.value} />;
            }
          }
        }
      }

      class DanmuList extends React.Component {
        render() {
          const danmuList = this.props.danmuList.map((value) => {
            return (
              <DanmuItem
                key={value.uniqueKey}
                config={this.props.config}
                value={value}
              />
            );
          });
          return <div className="danmu-list">{danmuList}</div>;
        }
      }

      class Root extends React.Component {
        constructor() {
          super();
          this.state = {
            danmuList: [],
            config: {
              statusBarDisplay: true,
              maxDanmuNumber: 100,
              numberFormat: {
                formatActivity: true,
                formatFansNum: true,
              },
              style: {
                bodyMargin: 0,
                listMargin: 5,
                backgroundColor: "#3B3B3B44",
                zoom: 1.0,
                font: "",
                fontWeight: 400,
                lineSpacing: 5,
                giftIconMaxHeight: 30,
                vipIcon: {
                  text: "爷",
                  backgroundColor: "#DC6385",
                  borderColor: "#BC5573",
                  textColor: "#FFFFFF",
                },
                sVipIcon: {
                  text: "爷",
                  backgroundColor: "#FFCC00",
                  borderColor: "#DE8402",
                  textColor: "#FFFFFF",
                },
                adminIcon: {
                  text: "房",
                  backgroundColor: "#D2A25B",
                  borderColor: "#DE8402",
                  textColor: "#FFFFFF",
                },
                userName: {
                  textColor: "#00AAFF",
                },
                danmuContent: {
                  textColor: "#FFFFFF",
                },
              },
            },
          };
          const instance = this;

          if (window.location.href === "about:blank") {
            internal = true;
          }

          /*start-actual-use*/ /*
            const ws = new WebSocket("ws://localhost:{{port}}");
            /*end-actual-use*/
          /*start-for-coding*/
          const ws = new WebSocket("ws://localhost:25555");
          /*end-for-coding*/
          ws.onmessage = function (event) {
            instance.processCommand(event.data);
          };

          /*start-for-coding*/
          window.onload = function () {
            const medalInfo = {
              anchor_roomid: 999999999,
              anchor_uname: "诶嘿",
              guard_level: 0,
              icon_id: 0,
              is_lighted: 1,
              medal_color: 1725515,
              medal_color_border: 6809855,
              medal_color_end: 1725515,
              medal_color_start: 5414290,
              medal_level: 12,
              medal_name: "诶嘿",
              special: "",
              target_id: 9999999999,
            };
            medalInfo.guard_level = 3;

            const list = [
              {
                cmd: "configUpdate",
                config: {
                  danmuReceiver: {
                    serverUrl: "wss://broadcastlv.chat.bilibili.com/sub",
                    roomid: 953650,
                    heartBeatPeriod: 30,
                  },
                  internalBrowser: {
                    webSocketServer: {
                      port: 25555,
                    },
                    width: 400,
                    height: 600,
                    posX: 0.0,
                    posY: 0.0,
                  },
                  internalViewConfig: {
                    statusBarDisplay: true,
                    maxDanmuNumber: 100,
                    numberFormat: {
                      formatActivity: true,
                      formatFansNum: true,
                    },
                    style: {
                      bodyMargin: 0,
                      listMargin: 5,
                      backgroundColor: "#3B3B3B44",
                      zoom: 1.0,
                      font: "",
                      fontWeight: 400,
                      lineSpacing: 5,
                      giftIconMaxHeight: 30,
                      vipIcon: {
                        text: "爷",
                        backgroundColor: "#DC6385",
                        borderColor: "#BC5573",
                        textColor: "#FFFFFF",
                      },
                      sVipIcon: {
                        text: "爷",
                        backgroundColor: "#FFCC00",
                        borderColor: "#DE8402",
                        textColor: "#FFFFFF",
                      },
                      adminIcon: {
                        text: "房",
                        backgroundColor: "#D2A25B",
                        borderColor: "#DE8402",
                        textColor: "#FFFFFF",
                      },
                      userName: {
                        textColor: "#00AAFF",
                      },
                      danmuContent: {
                        textColor: "#FFFFFF",
                      },
                    },
                  },
                  otherViewConfig: {
                    statusBarDisplay: true,
                    maxDanmuNumber: 100,
                    numberFormat: {
                      formatActivity: false,
                      formatFansNum: false,
                    },
                    style: {
                      bodyMargin: 0,
                      listMargin: 5,
                      backgroundColor: "#000000AA",
                      zoom: 1.0,
                      font: "",
                      fontWeight: 400,
                      lineSpacing: 5,
                      giftIconMaxHeight: 30,
                      vipIcon: {
                        text: "爷",
                        backgroundColor: "#DC6385",
                        borderColor: "#BC5573",
                        textColor: "#FFFFFF",
                      },
                      sVipIcon: {
                        text: "爷",
                        backgroundColor: "#FFCC00",
                        borderColor: "#DE8402",
                        textColor: "#FFFFFF",
                      },
                      adminIcon: {
                        text: "房",
                        backgroundColor: "#D2A25B",
                        borderColor: "#DE8402",
                        textColor: "#FFFFFF",
                      },
                      userName: {
                        textColor: "#00AAFF",
                      },
                      danmuContent: {
                        textColor: "#FFFFFF",
                      },
                    },
                  },
                },
              },
              {
                cmd: "DANMU_MSG",
                fontsize: 25,
                color: 16777215,
                timestamp: 1231254885,

                content: "message",

                uid: 41925356,
                uName: "Username",
                isAdmin: 1,
                isVip: 1,
                isSVip: 1,

                medalInfo: medalInfo,

                userUL: 20,

                userTitle: "title-438-1",
                userTitle1: "title-438-1",
              },
              {
                cmd: "SUPER_CHAT_MESSAGE",
                background_bottom_color: "#2A60B2",
                background_color: "#EDF5FF",
                background_color_end: "#405D85",
                background_color_start: "#3171D2",
                background_icon: "",
                background_image:
                  "https://i0.hdslb.com/bfs/live/a712efa5c6ebc67bafbe8352d3e74b820a00c13e.png",
                background_price_color: "#7497CD",
                color_point: 0.7,
                dmscore: 48,
                end_time: 1628959829,
                gift: {
                  gift_id: 12000,
                  gift_name: "醒目留言",
                  num: 1,
                },
                id: 2180493,
                is_ranked: 1,
                is_send_audit: "0",
                medal_info: {
                  anchor_roomid: 904823,
                  anchor_uname: "Key725",
                  guard_level: 0,
                  icon_id: 0,
                  is_lighted: 1,
                  medal_color: "#be6686",
                  medal_color_border: 12478086,
                  medal_color_end: 12478086,
                  medal_color_start: 12478086,
                  medal_level: 13,
                  medal_name: "老Key",
                  special: "",
                  target_id: 11332884,
                },
                message:
                  "包老师，我派派卡白金好几天了，请祝我早日单排上钻吧，那样就有人愿意陪我玩了",
                message_font_color: "#A3F6FF",
                message_trans: "",
                price: 30,
                rate: 1000,
                start_time: 1628959769,
                time: 60,
                token: "A4C70086",
                trans_mark: 0,
                ts: 1628959769,
                uid: 22564837,
                user_info: {
                  face: "https://i1.hdslb.com/bfs/face/8ca5af95fb8db793203ece34a9b5d4b039536aa0.jpg",
                  face_frame: "",
                  guard_level: 0,
                  is_main_vip: 1,
                  is_svip: 0,
                  is_vip: 0,
                  level_color: "#61c05a",
                  manager: 0,
                  name_color: "#666666",
                  title: "0",
                  uname: "纪阳同学",
                  user_level: 12,
                },
                roomid: "7953876",
              }, // SUPER_CHAT_MESSAGE
              {
                cmd: "SEND_GIFT",
                action: "投喂",
                batch_combo_id: "ba543138-c9de-4e45-98ad-071eba24efbb",
                batch_combo_send: {
                  action: "投喂",
                  batch_combo_id: "ba543138-c9de-4e45-98ad-071eba24efbb",
                  batch_combo_num: 1,
                  blind_gift: {
                    blind_gift_config_id: 20,
                    gift_action: "爆出",
                    original_gift_id: 31005,
                    original_gift_name: "紫金宝盒",
                  },
                  gift_id: 31003,
                  gift_name: "麦克风",
                  gift_num: 1,
                  send_master: null,
                  uid: 312294960,
                  uname: "祈愿相随の",
                },
                beatId: "",
                biz_source: "Live",
                blind_gift: {
                  blind_gift_config_id: 20,
                  gift_action: "爆出",
                  original_gift_id: 31005,
                  original_gift_name: "紫金宝盒",
                },
                broadcast_id: 0,
                coin_type: "gold",
                combo_resources_id: 1,
                combo_send: {
                  action: "投喂",
                  combo_id: "78419810-4360-410b-b000-fbf5f2cf087e",
                  combo_num: 1,
                  gift_id: 31003,
                  gift_name: "麦克风",
                  gift_num: 1,
                  send_master: null,
                  uid: 312294960,
                  uname: "祈愿相随の",
                },
                combo_stay_time: 5,
                combo_total_coin: 11000,
                crit_prob: 0,
                demarcation: 2,
                discount_price: 10000,
                dmscore: 80,
                draw: 0,
                effect: 0,
                effect_block: 0,
                face: "https://i0.hdslb.com/bfs/face/f30a9401a0ea2cf90325b94f67203454e1b16b12.jpg",
                giftId: 31003,
                giftName: "麦克风",
                giftType: 0,
                gold: 0,
                guard_level: 0,
                is_first: true,
                is_special_batch: 0,
                magnification: 1,
                medal_info: {
                  anchor_roomid: 0,
                  anchor_uname: "",
                  guard_level: 0,
                  icon_id: 0,
                  is_lighted: 1,
                  medal_color: 6126494,
                  medal_color_border: 6126494,
                  medal_color_end: 6126494,
                  medal_color_start: 6126494,
                  medal_level: 5,
                  medal_name: "布丁ya",
                  special: "",
                  target_id: 294893147,
                },
                name_color: "",
                num: 1,
                original_gift_name: "",
                price: 11000,
                rcost: 371575234,
                remain: 0,
                rnd: "1290338572",
                send_master: null,
                silver: 0,
                super: 0,
                super_batch_gift_num: 1,
                super_gift_num: 1,
                svga_block: 0,
                tag_image: "",
                tid: "1628269455121000001",
                timestamp: 1628269455,
                top_list: null,
                total_coin: 10000,
                uid: 312294960,
                uname: "祈愿相随の",
              },
              {
                cmd: "ROOM_BLOCK_MSG",
                dmscore: 30,
                operator: 1,
                uid: 1738501816,
                uname: "huff1041wrp",
              },
              {
                cmd: "LIVE",
                live_key: "164639492459629874",
                voice_background: "",
                sub_session_key: "164639492459629874sub_time:1628945921",
                live_platform: "pc",
                live_model: 0,
                roomid: 953650,
              },
              {
                cmd: "PREPARING",
                roomid: "22551538",
              },
            ];

            list.forEach((value) => {
              instance.processCommand(value);
            });
          };
          /*end-for-coding*/
        }

        processCommand(command) {
          console.log(command);
          switch (command.cmd) {
            case "configUpdate": {
              this.setState({
                config: internal
                  ? command.config.internalViewConfig
                  : command.config.otherViewConfig,
              });
              break;
            }
            default: {
              let list = this.state.danmuList;
              command.uniqueKey = ++commandNum;
              list.push(command);
              while (
                list.length > 0 &&
                list.length > this.state.config.maxDanmuNumber
              ) {
                list.shift();
              }

              this.setState({
                danmuList: list,
              });
            }
          }
        }

        render() {
          return (
            <div className="root">
              <DanmuList
                config={this.state.config}
                danmuList={this.state.danmuList}
              />
            </div>
          );
        }
      }

      ReactDOM.render(<Root />, document.getElementById("app"));

      document.createElement("div");
    </script>
  </head>
  <body>
    <div id="app"></div>
  </body>
</html>
